============================================================
DOCKER MULTISTAGE BUILD - Analysis & Demonstration
============================================================

ğŸ“„ Analyzing: Dockerfile
   Found 2 build stage(s)

ğŸ”„ Build Stage Flow:
============================================================

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Stage 1: builder                                      â”‚
  â”‚ Base: python:3.11-slim                                â”‚
  â”‚ Instructions: WORKDIR, RUN, COPY                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚  COPY --from=builder
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Stage 2: runtime                                      â”‚
  â”‚ Base: python:3.11-slim                                â”‚
  â”‚ Instructions: WORKDIR, RUN, COPY, ENV, USER, EXPOSE, HEALTHCHECK, CMD â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ” Best Practices Validation:
------------------------------------------------------------
   âœ… Multistage Build: Uses named stages for smaller final image
   âœ… Slim Base Image: Uses slim/alpine variant for smaller size
   âœ… Non-root User: Runs as non-root user (security best practice)
   âœ… Layer Caching: Requirements copied before app code
   âœ… Health Check: Includes HEALTHCHECK for orchestration
   âœ… Pip Cache: Uses --no-cache-dir to reduce image size
   âœ… Stage Copying: Uses COPY --from to transfer artifacts

   Score: 7/7 checks passed

ğŸ“Š Estimated Size Comparison:
------------------------------------------------------------
   python:3.11 (single-stage)     : ~1000 MB
   python:3.11-slim (single-stage): ~500 MB
   python:3.11-slim (multistage)  : ~200 MB

   ğŸ’¾ Savings: ~800 MB (80% reduction)

   Excluded from final image:
   â€¢ build-essential (~150 MB)
   â€¢ gcc, g++ (~100 MB)
   â€¢ pip cache (~50 MB)
   â€¢ development headers (~50 MB)

ğŸ› ï¸  Build Commands:
------------------------------------------------------------
   # Build the full image
   docker build -t ml-service:v1 .

   # Build only the builder stage (for debugging)
   docker build --target builder -t ml-service:builder .

   # Run the container
   docker run -p 8000:8000 ml-service:v1

   # Test the health endpoint
   curl http://localhost:8000/health

============================================================
ğŸ“š Key Takeaways:
============================================================
   1. Multistage builds separate build-time from runtime dependencies
   2. COPY --from=builder transfers only needed artifacts
   3. Non-root USER improves container security
   4. Copy requirements.txt first for better layer caching
   5. HEALTHCHECK enables container orchestration integration